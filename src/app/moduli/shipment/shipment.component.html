<app-navbar></app-navbar>
<app-widzard>
  <!-- <button
    class="mx-auto py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
    (click)="showLocalStorage()"
    >
    Show Storage
  </button> -->
  <div
    *ngIf="isLoading"
    class="h-full justify-center items-center mx-auto justify-items-center"
  >
    <mat-icon class="animate-spin">hourglass_bottom</mat-icon>
  </div>
  <form [formGroup]="formShipment">
    <ng-container *ngIf="showInput; else serviceChoice">
      <div *ngIf="currentModule?.packagesDetails.enable">
        <div class="flex">
          <button
            [disabled]="
              packageNumber > currentModule.packagesDetails.fixedpackagesNumber
            "
            class="mx-auto py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            (click)="addPackage()"
          >
            Aggiungi collo
          </button>

          <button
            *ngIf="packageNumber >= 1"
            class="mx-auto py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            (click)="removePackage()"
          >
            Rimuovi collo
          </button>
        </div>

        <div formArrayName="dimensions">
          <div *ngFor="let package of dimensions.controls; let i = index">
            <div
              class="md:flex md:flex-row w-full items-center w-full p-2"
              [formGroupName]="i"
            >
              <span class="mr-6">{{ i + 1 }})</span>
              <div
                *ngFor="let field of fieldsLabel"
                class="justify-items-center w-full mb-1"
              >
                <div class="grid grid-cols-2 md:grid-cols-1">
                  <label>{{ translations[field.label] }}*</label>
                  <input
                    formControlName="{{ field.label }}"
                    step="{{ field.step }}"
                    type="number"
                    [min]="field.min"
                    [max]="field.max"
                    class="w-28 lg:w-32 shadow-sm sm:text-sm border-gray-300 rounded-md"
                    placeholder="{{ field.placeholder }}"
                  />
                  <div
                    *ngIf="
                      formShipment.get(field.label)?.invalid &&
                      formShipment.get(field.label)?.errors &&
                      (formShipment.get(field.label)?.dirty ||
                        formShipment.get(field.label)?.touched)
                    "
                  >
                    <small
                      class="text-danger"
                      *ngIf="
                        formShipment.get(field.label)?.hasError('required')
                      "
                    >
                      This field is required.
                    </small>
                    <small
                      class="text-danger"
                      *ngIf="
                        formShipment.get(field.label)?.hasError('minlength')
                      "
                    >
                      The minimum length for this field is
                      {{formShipment.get(field.label)?.errors?.["minlength"].requiredLength}}
                      characters.
                    </small>
                    <small
                      class="text-danger"
                      *ngIf="
                        formShipment.get(field.label)?.hasError('maxlength')
                      "
                    >
                      The maximum length for this field is
                      {{formShipment.get(field.label)?.errors?.["maxlength"].requiredLength}}
                      characters.
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:pt-5"
        *ngIf="currentModule?.insurance.enable"
      >
        <label
          for="outwardInsurance"
          class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2"
        >
          {{ translations[currentModule.insurance.label] }}
        </label>
        <div class="mt-1 sm:mt-0 sm:col-span-2">
          <input
            *ngIf="!isDocumentShipment"
            [formControlName]="'outwardInsurance'"
            id="outwardInsurance"
            name="outwardInsurance"
            type="number"
            [min]="0"
            class="max-w-lg block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:max-w-xs sm:text-sm border-gray-300 rounded-md"
          />
          <input
            *ngIf="isDocumentShipment"
            [formControlName]="'outwardInsurance'"
            id="outwardInsurance"
            name="outwardInsurance"
            type="checkbox"
            class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
          />
        </div>
      </div>

      <div
        class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:pt-5 mb-5"
        *ngIf="
          currentModule?.returnLabel.enable &&
          currentModule?.returnLabel.insurance.enable
        "
      >
        <label
          for="returnInsurance"
          class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2"
        >
          {{ translations[currentModule.returnLabel.insurance.label] }}
        </label>
        <div class="mt-1 sm:mt-0 sm:col-span-2">
          <input
            *ngIf="!isDocumentShipment"
            [formControlName]="'returnInsurance'"
            id="returnInsurance"
            name="returnInsurance"
            type="number"
            [min]="0"
            class="max-w-lg block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:max-w-xs sm:text-sm border-gray-300 rounded-md"
          />
          <input
            *ngIf="isDocumentShipment"
            [formControlName]="'returnInsurance'"
            id="returnInsurance"
            name="returnInsurance"
            type="checkbox"
            class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
          />
        </div>
      </div>

      <div
        class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5"
      >
        <label
          for="codiceSconto"
          class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2"
        >
          {{
            translations["codiceSconto"]
              ? translations["codiceSconto"]
              : "codiceSconto"
          }}
        </label>
        <div class="mt-1 sm:mt-0 sm:col-span-2">
          <input
            [formControlName]="'codiceSconto'"
            id="codiceSconto"
            name="codiceSconto"
            type="text"
            class="max-w-lg block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:max-w-xs sm:text-sm border-gray-300 rounded-md"
          />
        </div>
      </div>

      <div class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:pt-5 mb-5">
        <label
          for="termsconditions"
          class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2"
        >
          {{ translations.lbl_termsconditions }}
        </label>
        <div class="mt-1 sm:mt-0 sm:col-span-2">
          <input
            [formControlName]="'termsconditions'"
            id="termsconditions"
            name="termsconditions"
            type="checkbox"
            checked
            class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
          />
        </div>
      </div>

      <button
        [disabled]="!formShipment.value.termsconditions"
        class="focus:ring-1 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-4"
        [class]="
          formShipment.valid && formShipment.value.termsconditions
            ? 'text-white bg-yellow-400 cursor-pointer'
            : 'text-slate-300 bg-yellow-200 cursor-not-allowed'
        "
        type="button"
        (click)="confirmInsurance()"
      >
        Conferma dettagli
      </button>
    </ng-container>
    <ng-template #serviceChoice>
      <!-- {{ isLoading }} -->
      <!-- TODO da sistemare -->
      <div *ngIf="pickupAvailability">
        <label
          *ngIf="pickupAvailability === 'KO'"
          class="text-base font-medium text-red-400"
        >
          non disponibile per il ritiro in giornata
        </label>
        <label
          *ngIf="pickupAvailability === 'OK'"
          class="text-base font-medium text-green-400"
        >
          disponibile per il ritiro in giornata
        </label>

        <fieldset class="mt-4">
          <div
            class="space-y-4 sm:flex sm:items-center sm:space-y-0 sm:space-x-10"
          >
            <div class="flex items-center" *ngIf="pickupAvailability === 'OK'">
              <input
                name="pickup-time"
                type="radio"
                class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300"
              />
              <label class="ml-3 block text-sm font-medium text-gray-700">
                ritiro oggi alle 15:00
              </label>
            </div>

            <div class="flex items-center">
              <input
                checked
                name="pickup-time"
                type="radio"
                class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300"
              />
              <label class="ml-3 block text-sm font-medium text-gray-700">
                ritiro domani alle 10:00
              </label>
            </div>
          </div>
        </fieldset>
      </div>

      <div
        *ngIf="outwardCostExposure.length"
        class="flex flex-wrap justify-center space-x-4 mt-4"
      >
        andata:
        <div
          *ngFor="let service of outwardCostExposure"
          class="bg-white p-4 rounded-lg shadow-lg h-80 w-auto relative mb-4"
          (click)="selectCourier('outward', service)"
          [ngClass]="
            chosenCourier?.outward.serviceName === service.serviceName
              ? 'shadow-lg shadow-red-500/50'
              : 'shadow-lg'
          "
        >
          corriere: {{ service.courier }}
          <hr />
          service: {{ service.serviceName }}
          <hr />
          totale: {{ service.data.totale }}
          <hr />
          varie: {{ service.data.varie }}
          <hr />
          nolo: {{ service.data.nolo }}
          <hr />
          <div *ngFor="let varie_d of service.data.varie_dettaglio | keyvalue">
            {{ varie_d.key }}: {{ varie_d.value }}
          </div>
        </div>
      </div>

      <div
        *ngIf="returnCostExposure.length"
        class="flex flex-wrap justify-center space-x-4 mt-4"
      >
        ritorno:
        <div
          *ngFor="let service of returnCostExposure"
          class="bg-white p-4 rounded-lg h-80 w-auto relative mb-4"
          (click)="selectCourier('return', service)"
          [ngClass]="
            chosenCourier?.return.serviceName === service.serviceName
              ? 'shadow-lg shadow-red-500/50'
              : 'shadow-lg'
          "
        >
          corriere: {{ service.courier }}
          <hr />
          service: {{ service.serviceName }}
          <hr />
          totale: {{ service.data.totale }}
          <hr />
          varie: {{ service.data.varie }}
          <hr />
          nolo: {{ service.data.nolo }}
          <hr />
          <div *ngFor="let varie_d of service.data.varie_dettaglio | keyvalue">
            {{ varie_d.key }}: {{ varie_d.value }}
          </div>
        </div>
      </div>
      <button
        type="button"
        (click)="incrementStep()"
        [disabled]="!canContinue"
        [ngClass]="
          canContinue
            ? 'bg-yellow-400 text-white'
            : 'bg-yellow-200 text-slate-200 cursor-not-allowed'
        "
        class="focus:ring-1 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-4 cursor-pointer"
      >
        Continua
      </button>
    </ng-template>
  </form>
</app-widzard>
