<app-modal
  [show]="showModal"
  [errors]="errors"
  (closeModal)="setCloseModal($event)"
></app-modal>
<app-navbar></app-navbar>
<app-wizard>
  <!-- Start Loading logo -->
  <div class="text-center" *ngIf="isLoading">
    <app-loader></app-loader>
  </div>
  <!-- End Loading logo -->

  <form [formGroup]="formShipment">
    <ng-container *ngIf="showInput; else serviceChoice">
      <div
        *ngIf="currentModule.documentFlag === 'ask'"
        class="flex flex-col md:flex-row space-x-0 md:space-x-4 md:space-y-0 space-y-2 py-2"
      >
        <div>{{ translations.lbl_ask_title }}</div>
        <div>
          <input
            class="text-red-dhl focus:ring-red-dhl"
            type="radio"
            name="ask"
            [value]="true"
            (click)="setDocumentShipment()"
            [defaultChecked]="store.isAskDocument"
          />
          {{ translations.lbl_ask_document }}
        </div>
        <div>
          <input
            class="text-red-dhl focus:ring-red-dhl"
            type="radio"
            name="ask"
            [value]="false"
            (click)="setGoodsShipment()"
            [defaultChecked]="!store.isAskDocument"
          />
          {{ translations.lbl_ask_goods }}
        </div>
      </div>
      <div *ngIf="currentModule?.packagesDetails.enable">
        <div class="flex w-full items-center">
          <p class="mb-6 font-medium w-full">
            {{ translations["lbl_return_packages"] }}
          </p>
          <div class="flex w-full justify-end space-x-2">
            <button
              *ngIf="packageNumber > 1"
              class="py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-dhl"
              (click)="removePackage()"
            >
              {{ translations["lbl_remove_package"] }}
            </button>
            <button
              *ngIf="!store.isAskDocument"
              [disabled]="
                packageNumber >
                currentModule.packagesDetails.fixedpackagesNumber
              "
              class="py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-dhl"
              (click)="addPackage()"
            >
              {{ translations["lbl_add_package"] }}
            </button>
          </div>
        </div>

        <ul
          formArrayName="dimensions"
          class="mt-6 md:divide-y-0 divide-y divide-y-2 divide-red-dhl"
        >
          <li
            *ngFor="let package of dimensions.controls; let i = index"
            class="list-none md:list-decimal"
          >
            <div
              class="sm:grid sm:grid-cols-2 md:grid-cols-4 w-full items-center w-full p-2 md:pt-6 gap-x-4"
              [formGroupName]="i"
            >
              <div
                *ngFor="let field of fieldsLabel"
                class="justify-items-center w-full mb-1"
              >
                <div class="relative w-full mb-6 group mx-auto">
                  <input
                    autocomplete="off"
                    formControlName="{{ field.label }}"
                    [ngClass]="dimensions.controls[i].get(field.label)?.errors?.['packagesDetails'] && dimensions.controls[i].get(field.label)?.touched ? 
                    'border-red-500' : 'border-gray-300'"
                    type="text"
                    class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-red-dhl focus:outline-none focus:ring-0 focus:border-red-dhl peer"
                    placeholder=" "
                  />
                  <label
                    class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-red-dhl peer-focus:dark:text-red-dhl peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
                  >
                    {{ translations[field.label] }}
                    <span class="text-red-400"> * </span>
                  </label>
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>

      <div
        class="md:grid md:grid-cols-2 gap-x-4 relative"
        *ngIf="
          currentModule.insurance.enable ||
          (currentModule.returnLabel.enable &&
            currentModule?.returnLabel.insurance.enable)
        "
      >
        <p class="col-span-full mb-6 font-medium">Inserisci le assicurazioni</p>
        <!-- assicurazione andata text -->
        <div
          class="relative w-full mb-6 group mx-auto"
          *ngIf="currentModule.insurance.enable && !isDocumentShipment"
        >
          <input
            [formControlName]="'outwardInsurance'"
            id="outwardInsurance"
            name="outwardInsurance"
            type="text"
            [ngClass]="
              formShipment.get('outwardInsurance')?.invalid &&
              formShipment.get('outwardInsurance')?.errors &&
              (formShipment.get('outwardInsurance')?.dirty ||
                formShipment.get('outwardInsurance')?.touched)
                ? 'border-red-500'
                : 'border-gray-300'
            "
            class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-red-dhl focus:outline-none focus:ring-0 focus:border-red-dhl peer"
            placeholder=" "
          />
          <label
            for="outwardInsurance"
            class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-red-dhl peer-focus:dark:text-red-dhl peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
          >
            {{ translations[currentModule.insurance.label] }} €
          </label>
        </div>

        <!-- assicurazione ritorno text -->
        <div
          class="relative w-full mb-6 group mx-auto"
          *ngIf="
            currentModule?.returnLabel.enable &&
            currentModule?.returnLabel.insurance.enable &&
            !isDocumentShipment
          "
        >
          <input
            [formControlName]="'returnInsurance'"
            id="returnInsurance"
            name="returnInsurance"
            type="text"
            [ngClass]="
              formShipment.get('returnInsurance')?.invalid &&
              formShipment.get('returnInsurance')?.errors &&
              (formShipment.get('returnInsurance')?.dirty ||
                formShipment.get('returnInsurance')?.touched)
                ? 'border-red-500'
                : 'border-gray-300'
            "
            class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-red-dhl focus:outline-none focus:ring-0 focus:border-red-dhl peer"
            placeholder=" "
          />
          <label
            for="returnInsurance"
            class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-red-dhl peer-focus:dark:text-red-dhl peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
          >
            {{ translations[currentModule.returnLabel.insurance.label] }} €
          </label>
        </div>

        <!-- assicurazione andata checkbox -->
        <div
          class="flex items-start mb-6"
          *ngIf="currentModule.insurance.enable && isDocumentShipment"
        >
          <div class="flex items-center h-5">
            <input
              [formControlName]="'outwardInsurance'"
              id="outwardInsurance"
              name="outwardInsurance"
              type="checkbox"
              class="w-4 h-4 bg-gray-50 rounded border border-gray-300 focus:ring-3 focus:ring-red-dhl text-red-dhl"
            />
          </div>
          <label
            for="outwardInsurance"
            class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300"
            >{{ translations[currentModule.insurance.label] }}</label
          >
        </div>

        <!-- assicurazione ritorno checkbox -->
        <div
          class="flex items-start mb-6"
          *ngIf="
            currentModule?.returnLabel.enable &&
            currentModule?.returnLabel.insurance.enable &&
            isDocumentShipment
          "
        >
          <div class="flex items-center h-5">
            <input
              [formControlName]="'returnInsurance'"
              id="returnInsurance"
              name="returnInsurance"
              type="checkbox"
              class="w-4 h-4 bg-gray-50 rounded border border-gray-300 focus:ring-3 focus:ring-red-dhl text-red-dhl"
            />
          </div>
          <label
            for="returnInsurance"
            class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300"
          >
            {{ translations[currentModule.returnLabel.insurance.label] }}
          </label>
        </div>
      </div>

      <ng-container *ngIf="showGoods_type && formShipment.get('goodType')">
        <p class="mb-6 font-medium">{{ translations["lbl_goods_type"] }}</p>
        <div class="relative w-full md:w-1/2 mb-6 group">
          <input
            [formControlName]="'goodType'"
            autocomplete="off"
            id="goodType"
            name="goodType"
            type="text"
            [ngClass]="
              formShipment.get('goodType')?.invalid &&
              formShipment.get('goodType')?.errors &&
              (formShipment.get('goodType')?.dirty ||
                formShipment.get('goodType')?.touched)
                ? 'border-red-500'
                : 'border-gray-300'
            "
            class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-red-dhl focus:outline-none focus:ring-0 focus:border-red-dhl peer"
            placeholder=" "
          />
          <label
            for="goodType"
            class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-red-dhl peer-focus:dark:text-red-dhl peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
          >
            {{ translations["lbl_goods_type"] }}
          </label>
        </div>
      </ng-container>

      <p class="mb-6 font-medium">{{ translations["lbl_coupon"] }}</p>
      <div class="relative w-full md:w-1/2 mb-6 group">
        <input
          [formControlName]="'codiceSconto'"
          autocomplete="off"
          id="codiceSconto"
          name="codiceSconto"
          type="text"
          class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-red-dhl focus:outline-none focus:ring-0 focus:border-red-dhl peer"
          placeholder=" "
        />
        <label
          for="codiceSconto"
          class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:left-0 peer-focus:text-red-dhl peer-focus:dark:text-red-dhl peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6"
        >
          {{ translations["lbl_coupon"] }} €
        </label>
      </div>

      <div class="flex flex-row space-x-4 justify-center">
        <button
          *ngIf="store.currentStep > 1 && !store.isLastModule"
          type="button"
          (click)="
            setDatiColli(); setInsurances(); service.handlePreviousStep()
          "
          class="bg-yellow-400 text-white focus:ring-1 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-4 cursor-pointer"
        >
          {{ translations["lbl_btn_back"] }}</button
        ><button
          class="focus:ring-1 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-4"
          [ngClass]="
            formShipment.valid
              ? 'text-white bg-yellow-400 cursor-pointer'
              : 'text-slate-300 bg-yellow-200 cursor-not-allowed'
          "
          type="button"
          (click)="confirmInsurance()"
        >
          Conferma dettagli
        </button>
      </div>
    </ng-container>
    <ng-template #serviceChoice>
      <div [ngClass]="store.hasReturnShipment ? 'md:grid md:grid-cols-2' : ''">
        <!-- andata -->
        <section
          class="bg-white dark:bg-gray-900"
          *ngIf="outwardCostExposure.length"
        >
          <div class="px-4 mx-auto max-w-screen-xl lg:px-6">
            <div class="mx-auto max-w-screen-md text-center mb-8 lg:mb-12">
              <h1 class="text-xl font-semibold text-gray-900">
                {{ translations["lbl_choose_courier"] }}
              </h1>
            </div>
            <div
              class="space-y-8 lg:grid lg:grid-cols-2 sm:gap-6 xl:gap-10 lg:space-y-0"
            >
              <div
                *ngFor="let service of outwardCostExposure; let i = index"
                class="flex flex-col p-6 mx-auto max-w-lg text-center text-gray-900 bg-white rounded-lg border border-gray-100 shadow dark:border-gray-600 xl:p-5 dark:bg-gray-800 dark:text-white"
              >
                <div class="md:flex items-center space-x-2">
                  <input
                    class="focus:ring-red-500 h-6 w-6 text-red-600 border-gray-300"
                    type="radio"
                    [checked]="i === 0 ? true : false"
                    [value]="service.serviceName"
                    name="outward"
                    (click)="selectCourier('outward', service)"
                  />
                  <span class="text-2xl font-semibold">
                    {{ service.courier }}
                  </span>
                  <span
                    class="font-normal text-gray-500 sm:text-lg dark:text-gray-400"
                  >
                    {{ service.serviceName }}
                  </span>
                </div>

                <ng-container *ngIf="store.hasPayment">
                  <div class="flex justify-center items-baseline my-8">
                    <span class="mr-2 text-2xl font-extrabold">
                      totale: €{{ service.data.totale }}
                    </span>
                  </div>
                  <ul role="list" class="mb-8 space-y-1 text-left list-disc">
                    <li class="flex items-center space-x-3">
                      <span
                        >{{ translations["lbl_ancillary_price"] }}: €{{
                          service.data.varie
                        }}</span
                      >
                    </li>
                    <li class="flex items-center space-x-3">
                      <span>nolo: €{{ service.data.nolo }}</span>
                    </li>
                    <li
                      class="flex items-center space-x-3"
                      *ngFor="
                        let varie_d of service.data.varie_dettaglio | keyvalue
                      "
                    >
                      <span>{{ varie_d.key }}: €{{ varie_d.value }}</span>
                    </li>
                    <li class="flex items-center space-x-3" *ngIf="iva">
                      <span
                        >netto IVA: €{{
                          service.data.totale / ((iva + 100) / 100)
                            | number: "0.2-2"
                        }}</span
                      >
                    </li>
                  </ul>
                </ng-container>
              </div>
            </div>
          </div>
        </section>
        <!-- ritorno -->
        <section
          class="bg-white dark:bg-gray-900 mt-4 md:mt-0"
          *ngIf="returnCostExposure.length"
        >
          <div class="px-4 mx-auto max-w-screen-xl lg:px-6">
            <div class="mx-auto max-w-screen-md text-center mb-8 lg:mb-12">
              <h1 class="text-xl font-semibold text-gray-900">
                {{ translations["lbl_choose_return_courier"] }}
              </h1>
            </div>
            <div
              class="space-y-8 lg:grid lg:grid-cols-2 sm:gap-6 xl:gap-10 lg:space-y-0"
            >
              <div
                *ngFor="let service of returnCostExposure; let i = index"
                class="flex flex-col p-6 mx-auto max-w-lg text-center text-gray-900 bg-white rounded-lg border border-gray-100 shadow dark:border-gray-600 xl:p-5 dark:bg-gray-800 dark:text-white"
              >
                <div class="md:flex items-center space-x-2">
                  <input
                    class="focus:ring-red-500 h-6 w-6 text-red-600 border-gray-300"
                    type="radio"
                    [checked]="i === 0 ? true : false"
                    [value]="service.serviceName"
                    name="retrun"
                    (click)="selectCourier('return', service)"
                  />
                  <span class="text-2xl font-semibold">
                    {{ service.courier }}
                  </span>
                  <span
                    class="font-normal text-gray-500 sm:text-lg dark:text-gray-400"
                  >
                    {{ service.serviceName }}
                  </span>
                </div>
                <ng-container *ngIf="store.hasPayment">
                  <div class="flex justify-center items-baseline my-8">
                    <span class="mr-2 text-2xl font-extrabold">
                      {{ translations["lbl_total_price"] }}: €{{
                        service.data.totale
                      }}
                    </span>
                  </div>
                  <ul role="list" class="mb-8 space-y-1 text-left list-disc">
                    <li class="flex items-center space-x-3">
                      <span
                        >{{ translations["lbl_ancillary_price"] }}: €{{
                          service.data.varie
                        }}</span
                      >
                    </li>
                    <li class="flex items-center space-x-3">
                      <span
                        >{{ translations["lbl_total_price"] }}: €{{
                          service.data.nolo
                        }}</span
                      >
                    </li>
                    <li
                      class="flex items-center space-x-3"
                      *ngFor="
                        let varie_d of service.data.varie_dettaglio | keyvalue
                      "
                    >
                      <span>{{ varie_d.key }}: €{{ varie_d.value }}</span>
                    </li>
                    <li class="flex items-center space-x-3" *ngIf="iva">
                      <span>
                        {{ translations["lbl_total_price"] }}: €
                        {{
                          service.data.totale / ((iva + 100) / 100)
                            | number: "0.2-2"
                        }}
                      </span>
                    </li>
                  </ul>
                </ng-container>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="mt-4" *ngIf="chosenCourier.outward.courierCode">
        <div class="flex space-x-2" *ngIf="homePickup">
          <input
            class="text-red-dhl"
            type="radio"
            [name]="'ritiro'"
            value="servicePoint"
            [checked]="homePickup"
            (click)="clearPickupAviability()"
          />
          <span>ritiro presso service point</span>
        </div>
        <div class="flex space-x-2" *ngIf="pointPickup">
          <input
            class="text-red-dhl"
            (click)="checkPickupAviability(chosenCourier.outward.courierCode)"
            type="radio"
            [name]="'ritiro'"
            value="home"
            [checked]="!homePickup"
          />
          <span>ritiro a casa</span>
          <span *ngIf="pickupAvailability[chosenCourier.outward.courierCode]">
            ritiro: {{ pickupAvailability[chosenCourier.outward.courierCode] }}
          </span>
        </div>
      </div>

      <div class="flex flex-row space-x-4 justify-center">
        <button
          *ngIf="store.currentStep > 1 && !store.isLastModule"
          type="button"
          (click)="service.handlePreviousStep(true)"
          class="bg-yellow-400 text-white focus:ring-1 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-4 cursor-pointer"
        >
          {{ translations["lbl_btn_back"] }}
        </button>
        <button
          (click)="incrementStep()"
          [ngClass]="
            canContinue
              ? 'bg-yellow-400 text-white '
              : 'bg-yellow-200 text-slate-200'
          "
          class="focus:ring-1 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-4 cursor-pointer"
        >
          {{ translations["lbl_btn_forward"] }}
        </button>
      </div>
    </ng-template>
  </form>
</app-wizard>
