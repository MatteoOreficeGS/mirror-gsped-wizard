<app-navbar></app-navbar>
<app-widzard>
  <!-- <button
    class="mx-auto py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
    (click)="showLocalStorage()"
    >
    Show Storage
  </button> -->
  <div
    *ngIf="isLoading"
    class="h-full justify-center items-center mx-auto justify-items-center flex"
  >
    <mat-icon class="animate-spin">refresh</mat-icon>
  </div>
  <form [formGroup]="formShipment">
    <ng-container *ngIf="showInput; else serviceChoice">
      <div *ngIf="currentModule?.packagesDetails.enable">
        <div class="flex">
          <button
            [disabled]="
              packageNumber > currentModule.packagesDetails.fixedpackagesNumber
            "
            class="mx-auto py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            (click)="addPackage()"
          >
            Aggiungi collo
          </button>

          <button
            *ngIf="packageNumber >= 1"
            class="mx-auto py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            (click)="removePackage()"
          >
            Rimuovi collo
          </button>
        </div>

        <div formArrayName="dimensions">
          <div *ngFor="let package of dimensions.controls; let i = index">
            <div
              class="md:flex md:flex-row w-full items-center w-full p-2"
              [formGroupName]="i"
            >
              <span class="mr-6">{{ i + 1 }})</span>
              <div
                *ngFor="let field of fieldsLabel"
                class="justify-items-center w-full mb-1"
              >
                <!-- {{ dimensions.controls[i].get(field.value)?.errors?.['packageInvalid'] | json }} -->
                <div class="grid grid-cols-2 md:grid-cols-1">
                  <label>{{ translations[field.label] }}*</label>
                  <input
                    formControlName="{{ field.value }}"
                    [ngClass]="dimensions.controls[i].get(field.value)?.errors?.['packageInvalid'] && dimensions.controls[i].get(field.value)?.touched ? 
                    'border-red-500' : ''"
                    type="text"
                    class="w-28 lg:w-32 shadow-sm sm:text-sm rounded-md"
                    placeholder="{{ field.placeholder }}"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:pt-5"
        *ngIf="currentModule?.insurance.enable"
      >
        <label
          for="outwardInsurance"
          class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2"
        >
          {{ translations[currentModule.insurance.label] }} €
        </label>
        <div class="mt-1 sm:mt-0 sm:col-span-2">
          <input
            *ngIf="!isDocumentShipment"
            [formControlName]="'outwardInsurance'"
            id="outwardInsurance"
            name="outwardInsurance"
            type="text"
            [ngClass]="
              formShipment.get('outwardInsurance')?.invalid &&
              formShipment.get('outwardInsurance')?.errors &&
              (formShipment.get('outwardInsurance')?.dirty ||
                formShipment.get('outwardInsurance')?.touched)
                ? 'border-red-500'
                : 'border-gray-300'
            "
            class="max-w-lg block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:max-w-xs sm:text-sm rounded-md"
          />
          <input
            *ngIf="isDocumentShipment"
            [formControlName]="'outwardInsurance'"
            id="outwardInsurance"
            name="outwardInsurance"
            type="checkbox"
            class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
          />
        </div>
      </div>

      <div
        class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:pt-5 mb-5"
        *ngIf="
          currentModule?.returnLabel.enable &&
          currentModule?.returnLabel.insurance.enable
        "
      >
        <label
          for="returnInsurance"
          class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2"
        >
          {{ translations[currentModule.returnLabel.insurance.label] }} €
        </label>
        <div class="mt-1 sm:mt-0 sm:col-span-2">
          <input
            *ngIf="!isDocumentShipment"
            [formControlName]="'returnInsurance'"
            [ngClass]="
              formShipment.get('returnInsurance')?.invalid &&
              formShipment.get('returnInsurance')?.errors &&
              (formShipment.get('returnInsurance')?.dirty ||
                formShipment.get('returnInsurance')?.touched)
                ? 'border-red-500'
                : 'border-gray-300'
            "
            id="returnInsurance"
            name="returnInsurance"
            type="text"
            class="max-w-lg block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:max-w-xs sm:text-sm rounded-md"
          />
          <input
            *ngIf="isDocumentShipment"
            [formControlName]="'returnInsurance'"
            id="returnInsurance"
            name="returnInsurance"
            type="checkbox"
            class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
          />
        </div>
      </div>

      <div
        class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:border-t sm:border-gray-200 sm:pt-5"
      >
        <label
          for="codiceSconto"
          class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2"
        >
          {{
            translations["codiceSconto"]
              ? translations["codiceSconto"]
              : "codiceSconto"
          }}
        </label>
        <div class="mt-1 sm:mt-0 sm:col-span-2">
          <input
            [formControlName]="'codiceSconto'"
            id="codiceSconto"
            name="codiceSconto"
            type="text"
            class="max-w-lg block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:max-w-xs sm:text-sm border-gray-300 rounded-md"
          />
        </div>
      </div>

      <div class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start sm:pt-5 mb-5">
        <label
          for="termsconditions"
          class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2"
        >
          {{ termsConditions.textBefore }}
          <a [href]="termsConditions.link" target="_blank" class="underline">{{
            termsConditions.text
          }}</a>
          {{ termsConditions.textAfter }}
          {{ termsPrivacy.textBefore }}
          <a [href]="termsPrivacy.link" target="_blank" class="underline">{{
            termsPrivacy.text
          }}</a>
          {{ termsPrivacy.textAfter }}
        </label>
        <div class="mt-1 sm:mt-0 sm:col-span-2">
          <input
            [formControlName]="'termsconditions'"
            id="termsconditions"
            name="termsconditions"
            type="checkbox"
            class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
          />
        </div>
      </div>

      <button
        [disabled]="!formShipment.value.termsconditions"
        class="focus:ring-1 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-4"
        [class]="
          formShipment.valid && formShipment.value.termsconditions
            ? 'text-white bg-yellow-400 cursor-pointer'
            : 'text-slate-300 bg-yellow-200 cursor-not-allowed'
        "
        type="button"
        (click)="confirmInsurance()"
      >
        Conferma dettagli
      </button>
    </ng-container>
    <ng-template #serviceChoice>
      <!-- {{ isLoading }} -->
      <!-- TODO da sistemare -->
      <div *ngIf="pickupAvailability">
        <label
          *ngIf="pickupAvailability === 'KO'"
          class="text-base font-medium text-red-400"
        >
          non disponibile per il ritiro in giornata
        </label>
        <label
          *ngIf="pickupAvailability === 'OK'"
          class="text-base font-medium text-green-400"
        >
          disponibile per il ritiro in giornata
        </label>

        <fieldset class="mt-4">
          <div
            class="space-y-4 sm:flex sm:items-center sm:space-y-0 sm:space-x-10"
          >
            <div class="flex items-center" *ngIf="pickupAvailability === 'OK'">
              <input
                name="pickup-time"
                type="radio"
                class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300"
              />
              <label class="ml-3 block text-sm font-medium text-gray-700">
                ritiro oggi alle 15:00
              </label>
            </div>

            <div class="flex items-center">
              <input
                checked
                name="pickup-time"
                type="radio"
                class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300"
              />
              <label class="ml-3 block text-sm font-medium text-gray-700">
                ritiro domani alle 10:00
              </label>
            </div>
          </div>
        </fieldset>
      </div>
      <!-- andata -->
      <section
        class="bg-white dark:bg-gray-900"
        *ngIf="outwardCostExposure.length"
      >
        <div class="px-4 mx-auto max-w-screen-xl lg:px-6">
          <div class="mx-auto max-w-screen-md text-center mb-8 lg:mb-12">
            <h2
              class="text-4xl tracking-tight font-extrabold text-gray-900 dark:text-white"
            >
              Seleziona il corriere di andata
            </h2>
          </div>
          <div
            class="space-y-8 lg:grid lg:grid-cols-3 sm:gap-6 xl:gap-10 lg:space-y-0"
          >
            <div
              *ngFor="let service of outwardCostExposure"
              class="flex flex-col p-6 mx-auto max-w-lg text-center text-gray-900 bg-white rounded-lg border border-gray-100 shadow dark:border-gray-600 xl:p-8 dark:bg-gray-800 dark:text-white"
            >
              <div class="flex items-center space-x-2">
                <input
                  class="focus:ring-red-500 h-4 w-4 text-red-600 border-gray-300"
                  type="radio"
                  [value]="service.serviceName"
                  name="outward"
                  (click)="selectCourier('outward', service)"
                />
                <span class="text-2xl font-semibold">
                  {{ service.courier }}
                </span>
                <span
                  class="font-normal text-gray-500 sm:text-lg dark:text-gray-400"
                >
                  {{ service.serviceName }}
                </span>
              </div>

              <div class="flex justify-center items-baseline my-8">
                <span class="mr-2 text-2xl font-extrabold">
                  totale: {{ service.data.totale }}
                </span>
              </div>
              <ul role="list" class="mb-8 space-y-4 text-left list-disc">
                <li class="flex items-center space-x-3">
                  <span>varie: {{ service.data.varie }}</span>
                </li>
                <li class="flex items-center space-x-3">
                  <span>nolo: {{ service.data.nolo }}</span>
                </li>
                <li
                  class="flex items-center space-x-3"
                  *ngFor="
                    let varie_d of service.data.varie_dettaglio | keyvalue
                  "
                >
                  <span>{{ varie_d.key }}: {{ varie_d.value }}</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </section>
      <!-- ritorno -->
      <section
        class="bg-white dark:bg-gray-900"
        *ngIf="returnCostExposure.length"
      >
        <div class="px-4 mx-auto max-w-screen-xl lg:px-6">
          <div class="mx-auto max-w-screen-md text-center mb-8 lg:mb-12">
            <h2
              class="text-4xl tracking-tight font-extrabold text-gray-900 dark:text-white"
            >
              Seleziona il corriere di ritorno
            </h2>
          </div>
          <div
            class="space-y-8 lg:grid lg:grid-cols-3 sm:gap-6 xl:gap-10 lg:space-y-0"
          >
            <div
              *ngFor="let service of returnCostExposure"
              class="flex flex-col p-6 mx-auto max-w-lg text-center text-gray-900 bg-white rounded-lg border border-gray-100 shadow dark:border-gray-600 xl:p-8 dark:bg-gray-800 dark:text-white"
            >
              <div class="flex items-center space-x-2">
                <input
                  class="focus:ring-red-500 h-4 w-4 text-red-600 border-gray-300"
                  type="radio"
                  [value]="service.serviceName"
                  name="retrun"
                  (click)="selectCourier('return', service)"
                />
                <span class="text-2xl font-semibold">
                  {{ service.courier }}
                </span>
                <span
                  class="font-normal text-gray-500 sm:text-lg dark:text-gray-400"
                >
                  {{ service.serviceName }}
                </span>
              </div>

              <div class="flex justify-center items-baseline my-8">
                <span class="mr-2 text-2xl font-extrabold">
                  totale: {{ service.data.totale }}
                </span>
              </div>
              <ul role="list" class="mb-8 space-y-4 text-left list-disc">
                <li class="flex items-center space-x-3">
                  <span>varie: {{ service.data.varie }}</span>
                </li>
                <li class="flex items-center space-x-3">
                  <span>nolo: {{ service.data.nolo }}</span>
                </li>
                <li
                  class="flex items-center space-x-3"
                  *ngFor="
                    let varie_d of service.data.varie_dettaglio | keyvalue
                  "
                >
                  <span>{{ varie_d.key }}: {{ varie_d.value }}</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </section>
      <button
        type="button"
        (click)="incrementStep()"
        [disabled]="!canContinue"
        [ngClass]="
          canContinue
            ? 'bg-yellow-400 text-white'
            : 'bg-yellow-200 text-slate-200 cursor-not-allowed'
        "
        class="focus:ring-1 focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center mt-4 cursor-pointer"
      >
        Continua
      </button>
    </ng-template>
  </form>
</app-widzard>
